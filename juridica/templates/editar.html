<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar Registro Jurídico</title>

</head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<body>
    <style>
    .form-card {
        max-width: 900px;
        margin: 30px auto;
        background: #ffffff;
        border-radius: 10px;
        padding: 24px 28px;
        box-shadow: 0 8px 18px rgba(0,0,0,0.06);
    }

    .form-card h2 {
        font-size: 1.6rem;
        margin-bottom: 0.75rem;
    }

    .form-subtitle {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
    }

    /* separador de secciones */
    .form-section-title {
        font-size: 1rem;
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .form-section-title::before {
        content: "";
        width: 4px;
        height: 18px;
        border-radius: 999px;
        background: #005bc5;
    }

    /* espaciar campos */
    .form-group {
        margin-bottom: 1rem;
    }

    /* documentos */
    .doc-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .doc-info a {
        font-weight: 500;
        text-decoration: none;
    }

    .doc-info a:hover {
        text-decoration: underline;
    }

    /* drop area */
    #drop-area {
        background: #f9fafb;
        cursor: pointer;
        transition: background-color .2s ease, border-color .2s ease, transform .15s ease;
    }

    #drop-area.dragover {
        background: #e6f0ff;
        border-color: #005bc5 !important;
        transform: scale(1.01);
    }

    /* lista de archivos nuevos */
    #file-list li {
        font-size: 0.9rem;
    }

    /* botones inferiores */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 1.5rem;
    }

    </style>

<div class="container">

    <h2 class="text-center">Editar Registro Jurídico</h2>

    <form method="POST" enctype="multipart/form-data" class="form-horizontal">
        {% csrf_token %}

        <div class="form-group">
            <label for="folio">Folio</label>
            <input type="text" id="folio" name="folio" class="form-control" value="{{ registro.folio }}" required>
        </div>

        <div class="form-group">
            <label for="oficio">Oficio</label>
            <input type="text" id="oficio" name="oficio" class="form-control" value="{{ registro.oficio }}" required>
        </div>

        <div class="form-group">
            <label for="materia">Materia</label>
            <textarea id="materia" name="materia" class="form-control" rows="4" required>{{ registro.materia }}</textarea>
        </div>

        <div class="form-group">
            <label for="fecha_oficio">Fecha Oficio</label>
            <input type="date" id="fecha_oficio" name="fecha_oficio" class="form-control" value="{{ registro.fecha_oficio|date:'Y-m-d' }}" required>
        </div>

        <div class="form-group">
            <label for="fecha_respuesta">Fecha Respuesta</label>
            <input type="date" id="fecha_respuesta" name="fecha_respuesta" class="form-control" value="{{ registro.fecha_respuesta|date:'Y-m-d' }}" required>
        </div>

        <div class="form-group">
            <label for="respuesta">Respuesta</label>
            <textarea id="respuesta" name="respuesta" class="form-control" rows="3" required>{{ registro.respuesta }}</textarea>
        </div>

        <div class="form-group">
            <label for="asignacion">Asignación</label>
            <input type="text" id="asignacion" name="asignacion" class="form-control" value="{{ registro.asignacion }}" required>
        </div>

        <h5>Documentos actuales</h5>
        <ul class="list-group mb-3">
            {% for doc in registro.documentos.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ doc.archivo.url }}" target="_blank">{{ doc.nombre }}</a><br>
                    <small class="text-muted">
                        Subido: {{ doc.fecha_subida|date:"d-m-Y H:i" }}
                    </small>
                </div>
                <label class="text-danger ms-3 mb-0">
                    <input type="checkbox" name="eliminar_docs" value="{{ doc.id }}">
                    Eliminar
                </label>
            </li>
            {% empty %}
            <li class="list-group-item text-muted">No hay documentos asociados.</li>
            {% endfor %}
        </ul>

        <h5>Agregar nuevos documentos</h5>
        <div>
            <div id="drop-area" class="p-4 border rounded text-center" style="background:#f9f9f9; cursor:pointer;"></div>
                <p class="mb-2">Arrastra y suelta archivos aquí o haz clic para seleccionar</p>
                <button type="button" id="browse-btn" class="btn btn-outline-secondary btn-sm">Seleccionar archivos</button>
                <input id="file-input" type="file" name="archivos" multiple class="d-none" />
            </div>
            <ul id="file-list" class="list-group mt-3"></ul>  
</div>

        <button type="submit" class="btn btn-primary mt-3">Guardar Cambios</button>
    </form>
    <br>
    <a href="/">Volver</a>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const dropArea   = document.getElementById('drop-area');
    const fileInput  = document.getElementById('file-input');
    const browseBtn  = document.getElementById('browse-btn');
    const fileListUl = document.getElementById('file-list');

    // Array donde vamos a guardar los archivos seleccionados
    let selectedFiles = [];

    // ---------------------------
    // helpers
    // ---------------------------
    function bytesToSize(bytes) {
        if (bytes === 0) return '0 B';
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function rebuildInputFiles() {
        // Reconstruye fileInput.files con los archivos que quedan
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(f => dataTransfer.items.add(f));
        fileInput.files = dataTransfer.files;
    }

    function renderFileList() {
        fileListUl.innerHTML = '';

        if (selectedFiles.length === 0) {
            return;
        }

        selectedFiles.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';

            li.innerHTML = `
                <div class="text-start">
                    <strong>${file.name}</strong><br>
                    <small class="text-muted">${bytesToSize(file.size)}</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" data-index="${index}">
                    Quitar
                </button>
            `;

            fileListUl.appendChild(li);
        });

        // manejar clicks en botón "Quitar"
        fileListUl.querySelectorAll('button[data-index]').forEach(btn => {
            btn.addEventListener('click', function () {
                const idx = parseInt(this.getAttribute('data-index'));
                selectedFiles.splice(idx, 1);     // eliminar del array
                rebuildInputFiles();              // actualizar input.files
                renderFileList();                 // re-dibujar lista
            });
        });
    }

    function addFiles(files) {
        // files es un FileList o array-like
        Array.from(files).forEach(file => {
            // evitar duplicados por nombre + tamaño + fecha modif
            const exists = selectedFiles.some(f =>
                f.name === file.name &&
                f.size === file.size &&
                f.lastModified === file.lastModified
            );
            if (!exists) {
                selectedFiles.push(file);
            }
        });

        rebuildInputFiles();
        renderFileList();
    }

    // ---------------------------
    // Eventos
    // ---------------------------

    // click en el botón → abre selector de archivos
    browseBtn.addEventListener('click', () => fileInput.click());

    // click en el área completa → también abre selector
    dropArea.addEventListener('click', (e) => {
        // evitamos que el click en el botón se duplique
        if (e.target.id !== 'browse-btn') {
            fileInput.click();
        }
    });

    // cuando el usuario selecciona archivos por el input
    fileInput.addEventListener('change', function () {
        if (this.files && this.files.length > 0) {
            addFiles(this.files);
        }
    });

    // drag & drop
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.add('border-primary');
            dropArea.style.background = '#f8f9fa';
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.remove('border-primary');
            dropArea.style.background = '#fff';
        });
    });

    dropArea.addEventListener('drop', function (e) {
        const dt = e.dataTransfer;
        if (dt && dt.files && dt.files.length > 0) {
            addFiles(dt.files);
        }
    });
});
</script>

</div>

</body>
</html>
