
{% extends "base.html" %}
{% block contenido %}
{% load static %}


<style>
  .container {
    width: 60%;
    max-width: 900px;
    background: white;
    margin: auto;
    padding: 35px;
    border-radius: 14px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
  }

  .row {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    margin-top: 15px;
  }

  .col {
    display: flex;
    flex-direction: column;
  }

  .col-center {
    display: flex;
    justify-content: center;
    align-items: center;
    flex: 1;
  }

  .small-box{
    width: 260px;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
</style>

<div class="container">
  <h2>‚úèÔ∏è Editar Oficio</h2>

  <form method="POST" id="form-oficio" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- FILA 1: Folio y N¬∞ Oficio -->
    <div class="row">
      <div class="col">
        <label>Folio</label>
        <input class="small-box" type="text" name="folio" required value="{{ registro.folio }}">
      </div>

      <div class="col">
        <label>N¬∞ Oficio o Providencia Derivaci√≥n</label>
        <input class="small-box" type="text" name="oficio" required value="{{ registro.oficio }}">
      </div>
    </div>

    <!-- MATERIA -->
    <div class="row" style="margin-top: 20px;">
      <div class="col" style="width: 100%;">
        <label>Materia</label>
        <textarea name="materia" rows="3"
          style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"
        >{{ registro.materia }}</textarea>
      </div>
    </div>

    <!-- FILA 2: FECHAS -->
    <div class="row">
      <div class="col">
        <label>Fecha de Oficio</label>
        <input class="small-box fecha-nohabiles" type="date" name="fecha_oficio" required id="fecha_oficio"
          value="{{ registro.fecha_oficio|date:'Y-m-d' }}">
      </div>

      <div class="col">
        <label>Fecha de Respuesta</label>
        <input class="small-box fecha-nohabiles" type="date" name="fecha_respuesta" id="fecha_respuesta"
          value="{{ registro.fecha_respuesta|date:'Y-m-d' }}">
      </div>
    </div>

    <!-- ASIGNACI√ìN -->
    <div class="row" style="margin-top:20px;">
      <div class="col" style="width:100%;">
        <label style="display:block; margin-bottom:6px;">Asignaci√≥n</label>

        <input type="text" id="asignacion_search" placeholder="Buscar direcci√≥n..."
          style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px;" />

        <div id="asignacion_list"
          style="border:1px solid #ccc; border-radius:6px; padding:10px; max-height:220px; overflow:auto;">

          {% for item in asignaciones %}
            {% if item != "Otro" %}
              <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
                <input type="checkbox" name="asignacion[]" value="{{ item|escape }}"
                  {% if item in asignaciones_seleccionadas %}checked{% endif %}>
                {{ item }}
              </label>
            {% endif %}
          {% endfor %}

          <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
            <input type="checkbox" id="asig_otro_chk" name="asignacion[]" value="Otro"
              {% if asignacion_otro_texto %}checked{% endif %}>
            Otro
          </label>

          <div id="asig_otro_wrap" style="display:none; margin-top:8px;">
            <input type="text" id="asig_otro_txt" name="asignacion_otro"
              placeholder="Especifica cu√°l..."
              value="{{ asignacion_otro_texto }}"
              style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;" />
          </div>
        </div>

        <small class="text-muted">Marca una o varias opciones.</small>
      </div>
    </div>

    <!-- DIRIGIDO A / CC -->
    <div class="row" style="margin-top: 20px;">
      <div class="col" style="width: 100%;">
        <label>Dirigido a</label>
        <input type="text" name="dirigido_a" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"
          value="{{ registro.dirigido_a }}">
      </div>
    </div>

    <div class="row" style="margin-top: 15px;">
      <div class="col" style="width: 100%;">
        <label>CC</label>
        <input type="text" name="cc" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"
          value="{{ registro.cc }}">
      </div>
    </div>

    <!-- RESPUESTA -->
    <div class="row" style="margin-top: 20px;">
      <div class="col" style="width: 100%;">
        <label>Respuesta</label>
        <textarea name="respuesta" rows="4"
          style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"
        >{{ registro.respuesta }}</textarea>
      </div>
    </div>

    <!-- TERMINADO -->
    <div class="row" style="margin-top: 15px;">
      <div class="col" style="width: 100%;">
        <label style="display:flex; align-items:center; gap:10px; margin-top:8px;">
          <input type="checkbox" name="terminado" {% if registro.terminado %}checked{% endif %}>
          Marcar como terminado
        </label>
      </div>
    </div>

    <hr style="border:0; height:1px; background:linear-gradient(90deg, rgba(0,91,197,0), rgba(0,91,197,0.6), rgba(0,91,197,0)); margin:20px 0 24px;">

    <!-- DOCUMENTOS EXISTENTES -->
    <div class="row" style="margin-top: 10px;">
      <div class="col" style="width: 100%;">
        <label>Documentos existentes</label>

        {% if documentos %}
            <ul class="list-group mt-2">
                {% for d in documentos %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="text-start">
                    <strong>{{ d.nombre }}</strong><br>
                    <small class="text-muted">{{ d.fecha_subida }}</small>
                    </div>

                    <div style="display:flex; gap:8px;">
                    <a class="btn btn-azul btn-tooltip" title="Ver" href="{{ d.archivo.url }}" target="_blank">üìé</a>

                    <button
                        type="button"
                        class="btn btn-rojo btn-tooltip btn-doc-eliminar"
                        title="Eliminar"
                        data-delete-url="{% url 'documento_eliminar' d.id %}"
                    >‚ùå</button>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted mt-2">Sin documentos.</p>
            {% endif %}
      </div>
    </div>

    <!-- SUBIR NUEVOS DOCUMENTOS -->
    <div class="row" style="margin-top: 20px;">
      <div class="col" style="width: 100%;">
        <label>Agregar nuevos documentos</label>
      </div>
    </div>

    <div>
      <div id="drop-area" class="p-4 border rounded text-center" style="background:#fff; cursor:pointer;">
        <button type="button" id="browse-btn" class="btn btn-azul">Subir Documentos</button>
        <input id="file-input" type="file" name="archivos" multiple style="display: none;" />
      </div>

      <ul id="file-list" class="list-group mt-3"></ul>
    </div>

    <div>
      <hr style="border:0; height:1px; background:linear-gradient(90deg, rgba(0,91,197,0), rgba(0,91,197,0.6), rgba(0,91,197,0)); margin:20px 0 24px;">
    </div>
    <!-- BOTONES -->
    <div class="row">
      <div class="col-center">
        <a class="btn btn-azul btn-tooltip" title="Volver a la Lista" href="/">‚¨Ö</a>
      </div>

      <div class="col-center">
        <button class="btn btn-azul btn-tooltip" type="submit" title="Guardar cambios" style="position: relative;">üíæ</button>
      </div>
    </div>

  </form>

  <form id="form-delete-doc" method="POST" style="display:none;">
  {% csrf_token %}
</form>
</div>

<br>

<!-- JS: Buscador + Otro -->
<script>
(function () {
  const search = document.getElementById("asignacion_search");
  const list = document.getElementById("asignacion_list");
  if (!search || !list) return;

  const items = Array.from(list.querySelectorAll("label"))
    .filter(l => l.querySelector('input[type="checkbox"]'));

  const otroChk = document.getElementById("asig_otro_chk");
  const otroWrap = document.getElementById("asig_otro_wrap");
  const otroTxt = document.getElementById("asig_otro_txt");

  search.addEventListener("input", () => {
    const q = search.value.trim().toLowerCase();
    items.forEach(label => {
      const text = label.textContent.trim().toLowerCase();
      label.style.display = text.includes(q) ? "flex" : "none";
    });

    if (otroChk && otroChk.checked) otroWrap.style.display = "block";
  });

  if (otroChk) {
    const toggleOtro = () => {
      const on = otroChk.checked;
      otroWrap.style.display = on ? "block" : "none";
      otroTxt.required = on;
      if (!on) otroTxt.value = "";
    };
    otroChk.addEventListener("change", toggleOtro);

    // si ven√≠a marcado desde backend, mostrar al cargar
    if (otroChk.checked) {
      otroWrap.style.display = "block";
      otroTxt.required = true;
    } else {
      toggleOtro();
    }
  }
})();
</script>

<!-- JS: Drag & drop (agregar nuevos documentos) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const dropArea   = document.getElementById('drop-area');
  const fileInput  = document.getElementById('file-input');
  const browseBtn  = document.getElementById('browse-btn');
  const fileListUl = document.getElementById('file-list');

  if (!dropArea || !fileInput || !browseBtn || !fileListUl) return;

  let selectedFiles = [];

  function bytesToSize(bytes) {
    if (bytes === 0) return '0 B';
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + sizes[i];
  }

  function rebuildInputFiles() {
    const dataTransfer = new DataTransfer();
    selectedFiles.forEach(f => dataTransfer.items.add(f));
    fileInput.files = dataTransfer.files;
  }

  function renderFileList() {
    fileListUl.innerHTML = '';
    if (selectedFiles.length === 0) return;

    selectedFiles.forEach((file, index) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';

      li.innerHTML = `
        <div class="text-start">
          <strong>${file.name}</strong><br>
          <small class="text-muted">${bytesToSize(file.size)}</small>
        </div>
        <button type="button" class="btn btn-rojo btn-tooltip" title="Quitar" data-index="${index}">‚ùå</button>
      `;

      fileListUl.appendChild(li);
    });

    fileListUl.querySelectorAll('button[data-index]').forEach(btn => {
      btn.addEventListener('click', function () {
        const idx = parseInt(this.getAttribute('data-index'));
        selectedFiles.splice(idx, 1);
        rebuildInputFiles();
        renderFileList();
      });
    });
  }

  function addFiles(files) {
    Array.from(files).forEach(file => {
      const exists = selectedFiles.some(f =>
        f.name === file.name &&
        f.size === file.size &&
        f.lastModified === file.lastModified
      );
      if (!exists) selectedFiles.push(file);
    });

    rebuildInputFiles();
    renderFileList();
  }

  browseBtn.addEventListener('click', () => fileInput.click());

  dropArea.addEventListener('click', (e) => {
    if (e.target.id !== 'browse-btn') fileInput.click();
  });

  fileInput.addEventListener('change', function () {
    if (this.files && this.files.length > 0) addFiles(this.files);
  });

  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, function (e) {
      e.preventDefault();
      e.stopPropagation();
      dropArea.classList.add('border-primary');
      dropArea.style.background = '#f8f9fa';
    });
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, function (e) {
      e.preventDefault();
      e.stopPropagation();
      dropArea.classList.remove('border-primary');
      dropArea.style.background = '#fff';
    });
  });

  dropArea.addEventListener('drop', function (e) {
    const dt = e.dataTransfer;
    if (dt && dt.files && dt.files.length > 0) addFiles(dt.files);
  });
});
</script>

<!-- JS: Feriados + fines de semana (misma l√≥gica que crear) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fechaOficio    = document.getElementById('fecha_oficio');
  const fechaRespuesta = document.getElementById('fecha_respuesta');
  const form           = document.getElementById('form-oficio');

  if (!fechaOficio || !form) return;

  const inputsFecha = [fechaOficio, fechaRespuesta].filter(Boolean);
  const feriados = new Set();

  fetch('https://api.boostr.cl/holidays.json')
    .then(r => r.json())
    .then(data => {
      let lista = [];
      if (Array.isArray(data)) lista = data;
      else {
        for (const key in data) {
          if (Array.isArray(data[key])) { lista = data[key]; break; }
        }
      }
      lista.forEach(item => item?.date && feriados.add(item.date));
    })
    .catch(err => console.error('No se pudieron cargar los feriados:', err));

  function esFechaInvalida(valorFecha) {
    if (!valorFecha) return false;
    const fecha = new Date(valorFecha + 'T00:00:00');
    const diaSemana = fecha.getDay();
    if (diaSemana === 0 || diaSemana === 6) return 'No se permiten s√°bados ni domingos.';
    if (feriados.has(valorFecha)) return 'La fecha seleccionada es un d√≠a feriado.';
    return false;
  }

  function validarFechas(mostrarAlert = false) {
    for (const input of inputsFecha) {
      const valor = input.value;
      const msg = esFechaInvalida(valor);

      if (msg) {
        input.value = '';
        input.setCustomValidity(msg);
        input.reportValidity();
        if (mostrarAlert) alert(msg.includes('feriado') ? 'No se puede guardar en un d√≠a feriado.' : msg);
        return false;
      } else {
        input.setCustomValidity('');
      }
    }
    return true;
  }

  inputsFecha.forEach(input => input.addEventListener('change', () => validarFechas(false)));

  // Si quieres bloquear submit tambi√©n:
  form.addEventListener('submit', (e) => {
    if (!validarFechas(true)) e.preventDefault();
  });
});
</script>

<script>
document.addEventListener("click", function(e) {
  const btn = e.target.closest(".btn-doc-eliminar");
  if (!btn) return;

  e.preventDefault();

  if (!confirm("¬øEliminar documento?")) return;

  const url = btn.getAttribute("data-delete-url");
  if (!url) return;

  const form = document.getElementById("form-delete-doc");
  form.setAttribute("action", url);
  form.submit();
});
</script>



{% endblock %}